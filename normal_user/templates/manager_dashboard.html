{% extends 'base.html' %}
{% load custom_template_tags %}
{% load static %}
{% load i18n %}
{% block title %}{% trans "Manager dasboard" %}{% endblock %}
{% block content %}
<!-- Begin Page Content -->
<div class="container-fluid">
  <div class="dashboard-body-part">

    <!-- for mobile device -->
    <div class="row">
      <div class="left-header-part mobile-device">
        <div class="country-wrapper">

          <div class="for-mobile">
            <div class="country-field">
              <a href="#" title=""><i class="fas fa-clock"></i> 10:00 am </a>
              <div class="c-logo-block media">
                <img class="align-self-center mr-2" src="{% static 'img/c-logo.png' %}" title="Blue Logo"
                  alt="Blue Logo">
                <p class="media-body"> USA </p>
              </div>
            </div>


            <div class="country-field">
              <a href="#" title=""><i class="fas fa-clock"></i> 10:00 am </a>
              <div class="c-logo-block media">
                <img class="align-self-center mr-2" src="{% static 'img/c-logo.png' %}" title="Blue Logo"
                  alt="Blue Logo">
                <p class="media-body"> USA </p>
              </div>
            </div>
          </div>

          <div class="for-mobile">
            <div class="country-field">
              <a href="#" title=""><i class="fas fa-clock"></i> 10:00 am </a>
              <div class="c-logo-block media">
                <img class="align-self-center mr-2" src="{% static 'img/c-logo.png' %}" title="Blue Logo"
                  alt="Blue Logo">
                <p class="media-body"> USA </p>
              </div>
            </div>

            <div class="country-field">
              <a href="#" title=""><i class="fas fa-clock"></i> 10:00 am </a>
              <div class="c-logo-block media">
                <img class="align-self-center mr-2" src="{% static 'img/c-logo.png' %}" title="Blue Logo"
                  alt="Blue Logo">
                <p class="media-body"> USA </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Content Row -->

    <div class="row">

      <!-- Area Chart -->
      <div class="col-xl-8 col-lg-7">

        <!-- Page Heading -->
        <div class="d-sm-flex align-items-center justify-content-between mb-2 mt-4">
          <h1 class="h3 mb-0 text-gray-800">{% trans "Team Connect" %}</h1>
        </div>

        <!-- Content Row -->
        <div class="row blocks-all">

          <!-- Earnings (Monthly) Card Example -->
          <div class="col-xl-2 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">{% trans "Total Employees" %}
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{manager_count}}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Earnings (Monthly) Card Example -->
          <div class="col-xl-2 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">{{user_timezones.timezone1}}
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{timezone1_count}}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Earnings (Monthly) Card Example -->
          <div class="col-xl-2 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">{{user_timezones.timezone2}}
                    </div>
                    <div class="row no-gutters align-items-center">
                      <div class="col-auto">
                        <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{timezone2_count}}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Pending Requests Card Example -->
          <div class="col-xl-2 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">{{user_timezones.timezone3}}
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{timezone3_count}}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-xl-2 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
              <div class="card-body">
                <div class="row no-gutters align-items-center">
                  <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">{{user_timezones.timezone4}}
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{timezone4_count}}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <div class="card shadow mb-4">
          <!-- Card Header - Dropdown -->
          <div class="card-header no-border py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary"> {% trans "Employees List" %} </h6>
            <a href="{% url 'employee_listing' %}"
              class="d-none d-sm-inline-block btn btn-sm btn-primary table-btn shadow-sm">{% trans "View All List" %}</a>
          </div>
          <!-- Table  -->
          <div class="table-responsive emp-list">
            <table class="table table-bordered" cellspacing="0" width="100%">
              <tr class="border-bottom-2">
                <th>{% trans "Serial no." %}</th>
                <th>{% trans "Name" %}</th>
                <th>{% trans "Location" %}</th>
                <th>{% trans "Current Location" %}</th>
                <th>{% trans "Department" %}</th>
                <th>{% trans "Function" %}</th>
                <th>{% trans "Status" %}</th>
                <th>{% trans "Action" %}</th>
              </tr>

              {% last_hba1c request.user.id as data %}
              {% if data %}
              {% for i in data %}
              <tr>
                <td>{{forloop.counter}}</td>
                <td><a href="{% url 'employee_profile' %}?employee_id={{i.user_id}}">{{i.name}}</a></td>
                <td>{{i.city}}</td>
                <th id="location_{{i.user_id}}">{{i.last_location}}</th>
                <td>{{i.department.departments}}</td>
                <td>{{i.function}}</td>
                <td>
                  {% user_status i.user_id as status %}
                  <i class="fas fa-circle {{status.icon_class}}-color" id="icon_{{i.user_id}}"></i>
                  <span class="user_online_status" data-attr="{{i.user_id}}"
                    id="status_{{i.user_id}}">{{status.user_status}}</span>
                </td>
                <td>
                  <div class="gray-circle">
                    <div class="icons">
                      <span>
                        <a href="{% url 'manager_chat' %}?query={{i.user.username}}" target="_blank"
                          data-toggle="tooltip" data-placement="top" title="{% trans "Chat Message" %}"> <i
                            class="far fa-comment-alt"></i></a></span>
                    </div>
                    <div class="icons">
                      <span class="comment_model" data-attr="{{i.user_id}}"
                        data-comment="{% userComment i.user_id as comment_data %}{{comment_data.comment}}"
                        data-name="{{i.name}}">
                        <a href="#" data-toggle="tooltip" data-placement="top" title="{% trans "Comment" %}"><i
                            class="far fa-comment"></i></a></span>
                    </div>
                    <div class="icons">
                      <span class="task_modal" data-attr="{{i.user_id}}">
                        <a href="#" data-toggle="tooltip" data-placement="top" title="{% trans "Task" %}">
                          <i class="fas fa-tasks"></i>
                        </a></span>
                    </div>
                    <div class="icons">
                      <span class="email_modal" data-attr="{{i}},{{i.name}}">
                        <a href="#" data-toggle="tooltip" data-placement="top" title="{% trans "Mail" %}">
                          <i class="far fa-envelope"></i>
                        </a></span>
                    </div>
                    <div class="icons">
                      <span class="alert_btn" data-attr="{{i.user_id}}">
                        <a href="#" data-toggle="tooltip" data-placement="top" title="{% trans "Alert" %}"><i
                            class="far fa-bell"></i></a></span>
                    </div>
                    <div class="icons">
                      <span class="open_schedule_calendar" data-attr="{{i.user_id}}" data-data='{% user_schedules i.user_id as schedule_data %}{% if schedule_data %}{% for i in schedule_data %}
                          <div class="slip-wrap d-flex py-md-2 py-2 mx-2 mx-md-3">
                            <div class="name-wrap rounded-circle light-gray mr-md-4 mr-2">{{forloop.counter}}</div>
                            <h4>
                              <strong>{% trans "Start" %}:</strong>
                              {{i.start_date|date:"d/m/Y"}}, <strong>{% trans "End" %}:</strong> {{i.end_date|date:"d/m/Y"}}, <strong>{% trans "Shift" %}:</strong> {{i.start_time |date:"h:i A"}} {% trans "to" %} {{i.end_time|date:"h:i A"}}
                            </h4>
                          </div>
                          {% endfor %}{% else %}no_data{% endif %}'>
                        <a href="#" data-toggle="tooltip" data-placement="top"
                          title="{% trans "Schedule Shifts/Timings" %}">
                          <i class="far fa-calendar-check"></i>
                        </a>
                      </span>
                    </div>
                    <div class="icons">
                      <span data-attr="{{i.name}},{{i.user.email}}" class="change_password_icon">
                        <a href="#" data-toggle="tooltip" data-placement="top" title="{% trans "Change Password" %}"><i
                            class="fas fa-unlock-alt"></i></a></span>
                    </div>
                    <div class="icons">
                      <span class="webcam_icon">
                        <a href="{% url 'meeting' i.user.id %}" target="_blank" data-toggle="tooltip"
                          data-placement="top" title="{% trans "Webcam" %}">
                          <i attr="{{ i.user.id }}" class="meeting_id fas fa-video"></i></a></span>
                    </div>

                    <div class="icons">
                          <span class="overtime_icon" data-attr="{{i.user_id}}">
                           <a href="#" data-toggle="tooltip" data-placement="top" title="{% trans 'Overtime' %}">
                          <i class="fas fa-clock"></i></a></span>
                    </div>  
                  </div>
                </td>
              </tr>
              {% endfor %}
              {% else %}
              <tr>
                <td colspan="7">
                  <h1>{% trans "No data found" %}</h1>
                </td>
              </tr>
              {% endif %}
            </table>
          </div>
        </div>

        <div class="card shadow mb-4 ScdBlock">
          <!-- Card Header - Dropdown -->
          <div class="card-header no-border py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary"> {% trans "Email List" %} </h6>

            <a href="{% url 'email_listing' %}"
              class="d-none d-sm-inline-block btn btn-sm btn-primary table-btn shadow-sm">
              {% trans "View All List" %}</a>
          </div>
          <!-- Table  -->
          <div class="table-responsive emp-list">
            <table class="table table-bordered" cellspacing="0" width="100%">
              <tr class="border-bottom-2">
                <th>{% trans "Serial No." %}</th>
                <th>{% trans "Date & Time" %}</th>
                <th>{% trans "From" %}</th>
                <th>{% trans "To" %}</th>
                <th>{% trans "Subject" %}</th>
                <th>{% trans "Description" %}</th>
                <th>{% trans "Reply" %}</th>
              </tr>
              {% if manager_emails %}
              {% for email in manager_emails %}
              <tr>
                <td>{{forloop.counter}}</td>
                <td>{{ email.created_manager|date:'d/m/Y , h:i A' }}</td>
                <td>{{manager_details.full_name}}</td>
                <td>{% user_name email.to_email as data %}{{data}}</td>
                <td>{{email.subject}}</td>
                <td>{{email.descrtiption}}</td>
                {% email_reply_split email.id as email_rep %}
                <td>
                  <!-- <span id="email_{{email.id}}">{{email_rep|safe}}</span> -->
                  <table id="email_replies_table_{{email.id}}">
                    {% for dd in email_rep %}
                    <tr>
                      <td>{{dd.email_reply}}</td>
                      <td>{{dd.email_reply_time|date:'d/m/Y , h:i A'}}</td>
                    </tr>
                    {% endfor %}
                  </table>
                </td>
              </tr>
              {% endfor %}
              {% else %}
              <tr>
                <td colspan="7">
                  <h1>{% trans "No data found" %}</h1>
                </td>
              </tr>
              {% endif %}

            </table>
          </div>
        </div>
      </div>

      <div class="col-xl-4 col-lg-5">
        <div class="card no-border-radius border-top-0 mb-4">
          <!-- Card Header - Dropdown -->
          <div class="card-header p-2 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-black1">{% trans "All Messages" %}</h6>
            <div class="search-block d-sm-inline-block form-inline navbar-search ml-auto">
              <div class="input-group">
                <!-- <input type="text" class="form-control border-0 small" placeholder="Search for..." aria-label="Search"
                  aria-describedby="basic-addon2" id="search_user" name="asdasd"> -->
                <input type="text" class="form-control border-0" placeholder="{% trans 'Search for' %}..." id="search_user">


                <!-- <div class="input-group-append mr-3">
                  <i class="fas fa-search fa-sm"></i>
                </div> -->
              </div>
            </div>

          </div>
          <!-- Card Body -->
          <div class="card-body message-part">
            <div class="short-top" id="threads_div">
              {% if chat_thread %}
              {% for chat in chat_thread %}
              {% manager_chat_info chat.id request.user.id as data %}
              <a class="block-part d-flex open_user_chat" target="_blank" data-attr="{{chat.id}}"
                data-chat="{{data.sender_id}}">
                <div class="img-wrap admin-img mr-3" id="{{chat.id}}_div_box">
                  <img src="{% static 'img/admin-demo.png' %}" class="admin-img mr-3" title="">

                </div>
                <div class="message-block mr-2 justify-content-center align-self-center">
                  <h5>{{data.reciever_name}} - {{data.sender_name}}</h5>
                  <p id="{{chat.id}}_message_list_msg">{{data.last_message}}</p>
                </div>
                <div class="time-block ml-auto justify-content-center align-self-center">
                  <p id="{{chat.id}}_message_list_date">{{data.time|date:'d/m/Y , h:i A'}}</p>
                </div>
              </a>
              {% endfor %}
              {% else %}
              <div class="d-flex flex-column h-100 justify-content-center no_chat_found">
                <div class="not-chat mt-5 text-center">
                  <i class="fab fa-rocketchat"></i>
                </div>
                <div class="not-found mt-2 text-center">
                  <h1>{% trans "No chats found" %}</h1>
                </div>
              </div>
              {% endif %}

            </div>

          </div>
        </div>

        <div class="card no-border-radius mb-4">
          <!-- Card Header - Dropdown -->
          <div class="card-header chats p-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">{% trans "Chat" %} </h6>

          </div>
          <!-- Card Body -->
          <div class="card-body message-part empl-chat manager-dash " id="chat_data">
            <div class="short-bottom d-flex flex-column justify-content-end">
              <div class="message-box" id="message-box-part">
                <div class="d-flex flex-column h-100 justify-content-center">
                  <div class="not-chat text-center">
                    <i class="fab fa-rocketchat"></i>
                  </div>
                  <div class="not-found mt-2 text-center">
                    <h1>{% trans "Chat will be shown here." %}</h1>
                  </div>
                </div>
              </div>
            </div>


          </div>
        </div>

      </div>
    </div>
  </div>

</div>
<!-- /.container-fluid -->

</div>
<!-- End of Main Content -->

</div>
<!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
  <i class="fas fa-angle-up"></i>
</a>




<!-- loader -->
<div class="loader-overlay" id="page_loader" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="sr-only">{% trans "Loading..." %}</span>
  </div>
</div>


<!-- Manager Alert Modal-->
<div class="adjust-clock task manager-alert modal" id="manager-alert" tabindex="-1" role="dialog"
  aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header py-1 flex-row align-items-center justify-content-between">
        <h5 class="modal-title" id="exampleModalLabel">{% trans "Manager's Alert" %} </h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <div class="close-btn mt-0">
            <span aria-hidden="true">×</span>
          </div>
        </button>
      </div>
      <div class="modal-body p-3 p-md-4 p-lg-4">
        <div class="row form-row">
          <div class="col-lg-12">
            <div class="form-group m-0">
              <label> {% trans "Alert message" %} <span class="color-red">*</span> </label>
              <textarea type="text" class="form-control" onKeyPress="if(this.value.length>300) return false;"
                placeholder="{% trans "Enter alert message" %}" id="alert_message"
                onkeyup="alert_validation()"></textarea>
              <label id="alert_message_error" style="display: none;color: red"></label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-top-0">
        <button class="d-sm-inline-block btn w-100 btn-sm btn-primary" type="button" id="send_alert_btn">
          {% trans "OK" %} </button>
      </div>
    </div>
  </div>
</div>


<!-- Manager Send Email Modal-->
<div class="adjust-clock task manager-email modal" id="manager-email" tabindex="-1" role="dialog"
  aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header py-1 flex-row align-items-center justify-content-between">
        <h5 class="modal-title" id="exampleModalLabel">{% trans "Send Email" %} : <span
            class="mr-2 d-lg-inline font-weight-bold text-black1 small word-style" id="email_to_name"></span></h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <div class="close-btn mt-0">
            <span aria-hidden="true">×</span>
          </div>
        </button>
      </div>
      <div class="modal-body p-3 p-md-4 p-lg-4">
        <div class="row form-row">
          <div class="col-lg-12">
            <div class="form-group">
              <label>{% trans "To" %} <span class="color-red">*</span></label>
              <input type="text" class="form-control" id="to_email" readonly>
            </div>
          </div>
          <div class="col-lg-12">
            <div class="form-group">
              <label>{% trans "From" %} <span class="color-red">*</span></label>
              <input type="text" class="form-control" value="{{request.user.email}}" id="from_email" readonly>
            </div>
          </div>

          <div class="col-lg-12">
            <div class="form-group">
              <label>{% trans "Subject" %} <span class="color-red">*</span></label>
              <input type="text" class="form-control" id="email_subject" placeholder='{% trans "Enter Subject" %}' required
                onkeyup="subject_validation()">
              <label id="email_subject_error" style="display: none;color: red"></label>
            </div>
          </div>

          <div class="col-lg-12">
            <div class="form-group m-0">
              <label>{% trans "Description" %} <span class="color-red">*</span></label>
              <textarea type="text" class="form-control" placeholder='{% trans "Enter Description" %}' id="email_description"
                onkeyup="description_validation()"></textarea>
              <label id="email_description_error" style="display: none;color: red"></label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-top-0">
        <button class="d-sm-inline-block btn btn-sm btn-primary px-5" type="button" id="send_email_btn">
          {% trans "Send" %} </button>
      </div>
    </div>
  </div>
</div>


<!-- Manager  Comment Modal-->
<div class="adjust-clock task manager-email comment modal" id="manager-comment" tabindex="-1" role="dialog"
  aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header py-1 flex-row align-items-center justify-content-between">
        <h5 class="modal-title" id="exampleModalLabel">{% trans "Comment to" %}: <span
            class="mr-2 d-lg-inline font-weight-bold text-black1 small word-style" id="comment_to_name"></span> </h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <div class="close-btn mt-0">
            <span aria-hidden="true">×</span>
          </div>
        </button>
      </div>
      <div class="modal-body p-3 p-md-4 p-lg-4">
        <div class="row form-row">
          <div class="col-lg-12">
            <div class="form-group m-0">
              <label>{% trans "Comment" %} <span class="color-red">*</span></label>
              <textarea type="text" class="form-control" placeholder="{% trans "Add your comment ....." %}"
                id="user-comment" onkeyup="comment_validation()"></textarea>
              <label id="comment_error" style="display: none;color: red"></label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-top-0">
        <button class="d-sm-inline-block btn btn-sm btn-primary px-5" type="button" id="save-comment" data-attr="">
          {% trans "Save" %}
        </button>
      </div>
    </div>
  </div>
</div>


<!--Manager Task Modal-->
<div class="adjust-clock alert task modal" id="manager-task" tabindex="-1" role="dialog"
  aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header py-1 flex-row align-items-center justify-content-between">
        <h5 class="modal-title" id="exampleModalLabel">{% trans "Task Window" %} </h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <div class="close-btn">
            <span aria-hidden="true">×</span>
          </div>
        </button>
      </div>
      <div class="modal-body p-3 p-md-4 p-lg-4">
        <div class="row form-row">
          <div class="col-lg-12">
            <div class="form-group">
              <label> {% trans "Date" %}: <span class="color-red">*</span></label>
              <input type="text" class="datepicker form-control" placeholder="MM/DD/YYYY" id="task_date" readonly>
              <!-- <input type="date" class="form-control" placeholder="Department Name" > -->
              <label id="task_date_error" style="display: none;color: red;"></label>
            </div>
          </div>
          <div class="col-lg-12">
            <div class="form-group m-0">
              <label>{% trans "Today Task" %} <span class="color-red">*</span></label>
              <textarea type="text" class="form-control" id="today_task" placeholder="{% trans "Add task" %}..."
                onkeyup="task_validation()"></textarea>
              <label id="task_error" style="display: none;color: red"></label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-top-0">
        <button class="d-sm-inline-block btn w-100 btn-sm btn-success" type="button" id="assign_task">
          {% trans "Assign" %} </button>
      </div>
    </div>
  </div>
</div>



<div class="submit-msg alert modal fade" id="universal_msg_modal" tabindex="-1" role="dialog"
  aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header py-2 flex-row align-items-center justify-content-between">
        <button class="close close-bntn" type="button" data-dismiss="modal" aria-label="Close">
          <div class="close-btn mt-0">
            <span aria-hidden="true">×</span>
          </div>
        </button>
      </div>
      <div class="modal-body">
        <div class="row form-row">
          <div class="col-lg-12 text-center">
            <p class="m-0" id="universal_msg"></p>
          </div>
        </div>
      </div>
      <div class="modal-footer border-top-0">
        <button class="d-sm-inline-block btn btn-sm btn-primary sbt-btn shadow-sm close-bntn" type="button"
          data-dismiss="modal"> {% trans "Ok" %} </button>
      </div>
    </div>
  </div>
</div>
<!-- end modal -->

<!-- change-password modal -->
<div class="adjust-clock task modal" id="change-password" tabindex="-1" role="dialog"
  aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header py-1 flex-row align-items-center justify-content-between">
        <h5 class="modal-title" id="exampleModalLabel">{% trans "Change Password" %} </h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <div class="close-btn mt-0">
            <span aria-hidden="true">×</span>
          </div>
        </button>
      </div>
      <div class="modal-body p-3 p-md-4 p-lg-4">
        <div class="row form-row ">
          <div class="col-lg-12">
            <div class="form-group form-row field-static">
              <label>{% trans "Name" %} : </label>
              <div class="col-sm-10">
                <input type="text" readonly class="form-control-plaintext" id="staticName" value="Name">
              </div>
            </div>
          </div>
          <div class="col-lg-12">
            <div class="form-group form-row field-static">
              <label>{% trans "Email" %} :</label>
              <div class="col-sm-10">
                <input type="text" readonly class="form-control-plaintext" id="staticEmail" value="email@example.com">
              </div>
            </div>
          </div>
          <div class="col-lg-12">
            <div class="form-group">
              <label>{% trans "Password" %} <span class="color-red">*</span> </label>
              <input type="password" class="form-control" placeholder="{% trans "Enter Password" %}" required=""
                id="password" onkeyup="password_validation()">
              <label id="password_label" style="display: none;color: red;"></label>
            </div>
          </div>
          <div class="col-lg-12">
            <div class="form-group m-0">
              <label>{% trans "Confirm Password" %} <span class="color-red">*</span></label>
              <input type="password" class="form-control" placeholder="{% trans "Enter Confirm Password" %}"
                id="confirm_password" onkeyup="confirm_password_validation()" required="">
              <label id="confirm_password_label" style="display: none;color: red;"></label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-top-0">
        <button class="d-sm-inline-block btn btn-sm btn-primary sbt-btn shadow-sm" type="button"
          id="change_password_btn"> {% trans "Submit" %} </button>
      </div>
    </div>
  </div>
</div>
<!-- end modal -->
<!--Start Overtime date-time  Modal-->
<div class="adjust-clock modal fade" id="overtime-date-time" tabindex="-1" role="dialog"
  aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header py-1 flex-row align-items-center justify-content-between">
        <h5 class="modal-title" id="exampleModalLabel"> {% trans "Select Extended Hours" %} </h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <div class="close-btn mt-0">
            <span aria-hidden="true">×</span>
          </div>
        </button>
      </div>

      <div class="modal-body">
        <div class="row form-row">
          <div class="col-lg-12">
            <form method='POST' action="{% url 'saveovertime' %}">
              {% csrf_token %}
            <table class="schedule-data" border="0">
              <tbody>
                <tr>
                   <td>
                    <div class="label-wrapper">
                      
                       <label id="start_date_scheduler_error" style="display: none;color: red;"></label>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td><span class="btn bg">{% trans 'Select Date' %} </span></td>
                   <td>
                    <div class="label-wrapper">
                      <span class="btn">
                        <div class="form-group">
                          <input type="text"  name="startdate" class="datepicker form-control schedule-date-cls" placeholder="YYYY/MM/DD" id="start_date_overtime">
                        </div>
                      </span>
                       <label id="start_date_scheduler_error" style="display: none;color: red;"></label>
                    </div>
                  </td>
                </tr>
                <tr>
                   

                  <tr>
                  <td><span class="btn bg">{% trans 'Start Time' %} </span></td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker" name="starttime" id="overtime_start_time" placeholder="HH:MM" />
                      </div>
                    </span>
                    <label id="start_time_scheduler_error" style="display: none;color: red;"></label>
                  </td>
                </tr> 
                <tr>
                  <td><span class="btn bg">{% trans 'End Time' %} </span></td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker"  name="endtime" id="overtime_end_time" placeholder="HH:MM"  onkeyup="overtime_validation()" />
                      </div>

                    </span>
                                      
                  </td>
                  <label id="end_time_scheduler_error" style="display: none;color: red;"></label>
                </tr>                 
              </tbody>
            </table>
          </div>
          <div class="col-lg-12 text-center">
            <label id="schedule-date-time-error" style="display: none;color: red;"></label>
            <div class="form-group">
                <input type="submits"  class="d-sm-inline-block btn btn-sm btn-primary sbt-btn shadow-sm" id="add_overtime_btns" class="btn btn-primary" value='{% trans "Set Overtime" %}'>
            </div>
          </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<!--Start Schedule date-time  Modal-->
<div class="adjust-clock modal fade" id="schedule-date-time" tabindex="-1" role="dialog"
  aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header py-1 flex-row align-items-center justify-content-between">
        <h5 class="modal-title" id="exampleModalLabel"> {% trans "Scheduler" %} </h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <div class="close-btn mt-0">
            <span aria-hidden="true">×</span>
          </div>
        </button>
      </div>

      <div class="modal-body">
        <div class="row form-row">
        <!--   <div class="col-lg-12 text-center">
            <h5 class="modal-title schedule-heading" id="exampleModalLabel">{% trans "Scheduler" %} </h5>
          </div> -->
          <div class="col-lg-12">
            <table class="schedule-data" border="0">
              <tbody>
                <tr>
                  <td><span class="btn bg">{% trans 'Day' %}</span> </td>
                  <td><span class="btn bg">{% trans 'Start Time' %} </span></td>
                  <td><span class="btn bg">{% trans 'End Time' %} </span></td>
                  <td><span class="btn bg">{% trans 'Day Off' %} </span></td>
                </tr>
                <tr class="schedule_tr">
                  <td> <span class="btn bg schedule_day">{% trans 'Monday' %}</span></td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_start_date" placeholder="HH:MM" />
                      </div>
                    </span>
                  </td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_end_date" placeholder="HH:MM" />
                      </div>
                    </span>
                  </td>
                  <td>
                    <div class="form-group">
                      <input type="checkbox" class="schedule_day_off" name="schedule_day_off" value="Boat">
                    </div>
                  </td>
                </tr>
                <tr class="schedule_tr">
                  <td> <span class="btn bg schedule_day">{% trans 'Tuesday' %} </span></td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_start_date" placeholder="HH:MM" />
                      </div>

                    </span>
                  </td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_end_date" placeholder="HH:MM" />
                      </div>

                    </span>
                  </td>
                  <td>
                    <div class="form-group">
                      <input type="checkbox" class="schedule_day_off" name="schedule_day_off" value="Boat">
                    </div>
                  </td>
                </tr>
                <tr class="schedule_tr">
                  <td><span class="btn bg schedule_day">{% trans 'Wednesday' %}</span>
                  </td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_start_date" placeholder="HH:MM" />
                      </div>

                    </span>
                  </td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_end_date" placeholder="HH:MM" />
                      </div>
                    </span>
                  </td>
                  <td>
                    <div class="form-group">
                      <input type="checkbox" class="schedule_day_off" name="schedule_day_off" value="Boat">
                    </div>
                  </td>
                </tr>
                <tr class="schedule_tr">
                  <td><span class="btn bg schedule_day">{% trans 'Thursday' %} </span></td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_start_date" placeholder="HH:MM" />
                      </div>
                    </span>
                  </td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_end_date" placeholder="HH:MM" />
                      </div>

                    </span>
                  </td>
                  <td>
                    <div class="form-group">
                      <input type="checkbox" class="schedule_day_off" name="schedule_day_off" value="Boat">
                    </div>
                  </td>
                </tr>
                <tr class="schedule_tr">
                  <td><span class="btn bg schedule_day">{% trans 'Friday' %} </span></td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_start_date" placeholder="HH:MM" />
                      </div>
                    </span>
                  </td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_end_date" placeholder="HH:MM" />
                      </div>

                    </span>
                  </td>
                  <td>
                    <div class="form-group">
                      <input type="checkbox" class="schedule_day_off" name="schedule_day_off" value="Boat">
                    </div>
                  </td>
                </tr>
                <tr class="schedule_tr">
                  <td><span class="btn bg schedule_day">{% trans 'Saturday' %}</span></td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_start_date" placeholder="HH:MM" />
                      </div>
                    </span>
                  </td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_end_date" placeholder="HH:MM" />
                      </div>
                    </span>
                  </td>
                  <td>
                    <div class="form-group">
                      <input type="checkbox" class="schedule_day_off" name="schedule_day_off" value="Boat">
                    </div>
                  </td>
                </tr>
                <tr class="schedule_tr">
                  <td><span class="btn bg schedule_day">{% trans 'Sunday' %}</span></td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_start_date" placeholder="HH:MM" />
                      </div>
                    </span>
                  </td>
                  <td>
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="form-control timepicker scheduler_end_date" placeholder="HH:MM" />
                      </div>
                    </span>
                  </td>
                  <td>
                    <div class="form-group">
                      <input type="checkbox" class="schedule_day_off" name="schedule_day_off" value="Boat">
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            <table class="schedule-data" border="0">
              <tbody>
                <tr>
                  <td><span class="btn bg">{% trans 'Start Date' %} </span></td>
                   <td>
                    <div class="label-wrapper">
                      <span class="btn">
                        <div class="form-group">
                          <input type="text" class="datepicker form-control schedule-date-cls" placeholder="MM/DD/YYYY" id="start_date_scheduler">
                        </div>
                      </span>
                       <label id="start_date_scheduler_error" style="display: none;color: red;"></label>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td><span class="btn bg">{% trans 'End Date' %} </span></td>
                   <td>
                    <div class="label-wrapper">
                    <span class="btn">
                      <div class="form-group">
                        <input type="text" class="datepicker form-control schedule-date-cls" placeholder="MM/DD/YYYY" id="end_date_scheduler">
                      </div>
                    </span>
                        <label id="end_date_scheduler_error" style="display: none;color: red;"></label>
                      </div>
                  </td>
                </tr>
               
              </tbody>
            </table>
          </div>
          <div class="col-lg-12 text-center">
            <label id="schedule-date-time-error" style="display: none;color: red;"></label>
            <div class="form-group">
              <button class="d-sm-inline-block btn btn-sm btn-primary sbt-btn shadow-sm" id="add_schedule_btn"
                type="button">{% trans "Set Schedule" %}</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End Schedule date-time  Modal-->


<div class="submit-msg alert modal fade" id="universal_msg_modal11" tabindex="-1" role="dialog"
  aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header py-1 flex-row align-items-center justify-content-between">
        <button class="close " type="button" data-dismiss="modal" aria-label="Close">
          <div class="close-btn">
            <span aria-hidden="true">×</span>
          </div>
        </button>
      </div>
      <div class="modal-body">
        <div class="row form-row">
          <div class="col-lg-12 text-center">
            <p class="m-0">{% trans "Something Went Wrong" %}</p>
          </div>
        </div>
      </div>
      <div class="modal-footer border-top-0">
        <button class="d-sm-inline-block btn btn-sm btn-primary sbt-btn shadow-sm " type="button" data-dismiss="modal">
          {% trans "Ok" %} </button>
      </div>
    </div>
  </div>
</div>


<!-- Bootstrap core JavaScript-->
<script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>

<!-- Core plugin JavaScript-->
<script src="{% static 'vendor/jquery-easing/jquery.easing.min.js' %}"></script>
<!-- <script src="{% static 'datetime-picker/moment.min.js' %}"></script> -->
<script src="{% static 'datetime-picker/wickedpicker.min.js' %}"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- <script type="text/javascript" src="http://wmh.github.io/jquery-scrollbox/jquery.scrollbox.js"></script> -->
<script type="text/javascript" src="{% static 'js/scrollbox.js' %}"></script>
<!-- Custom scripts for all pages-->
<script src="{% static 'js/sb-admin-2.js' %}"></script>

<script type="text/javascript">

  $("#schedule-date-time")

  $(document).on('change', ".schedule_day_off", function(){
    if($(this).is(":checked")){
      $(this).parent().parent().parent().find(".scheduler_start_date").prop('disabled', true)
      $(this).parent().parent().parent().find(".scheduler_start_date").val("{% trans 'Day Off' %}")
      $(this).parent().parent().parent().find(".scheduler_end_date").prop('disabled', true)
      $(this).parent().parent().parent().find(".scheduler_end_date").val("{% trans 'Day Off' %}")
    }
    else{
      $(this).parent().parent().parent().find(".scheduler_start_date").prop('disabled', false)
      $(this).parent().parent().parent().find(".scheduler_end_date").prop('disabled', false)
      
      var hours = new Date().getHours();
      var minutes = new Date().getMinutes();
      var hours = (hours)%24; 
      // var mid='AM';
      // if(hours==0){
      //   hours=12;
      // }
      // else if(hours>12)
      // {
      //   hours=hours%12;
      //   mid = 'PM';
      // }
      var ampm = (hours) >= 12 ? 'PM' : 'AM';

      hours = (hours) % 12;
      hours = hours ? hours : 12;
      hours = ((hours.toString()).length == 1) ? "0" + (hours).toString() : hours;
      minute = ((minutes.toString()).length == 1) ? "0" + minutes.toString() : minutes;

      $(this).parent().parent().parent().find(".scheduler_start_date").val(hours.toString()+" : "+minute.toString()+" "+ampm)
      $(this).parent().parent().parent().find(".scheduler_end_date").val(hours.toString()+" : "+minute.toString()+" "+ampm)
    }
  })


  $("#start_time").val("")
  $("#end_time").val("")

  $("#start_date").datepicker({ minDate: 0, dateFormat: 'dd/mm/yy' })
  // $("#start_date").datepicker("setDate", new Date());
  $(".schedule-date-cls").datepicker({ minDate: 0, dateFormat: 'mm/dd/yy' })


  $("#end_date").datepicker({ minDate: 0, dateFormat: 'dd/mm/yy' })
// , dateFormat: 'dd/mm/yy'
  //   var datepicker = $('#start_date');
  // datepicker.datepicker( {minDate: 0} );
  // datepicker.datepicker('setDate', new Date());

  //   $("#end_date").datepicker({ minDate: 0 })
  $('#task_date').on("cut copy paste", function (e) {
    e.preventDefault();
  });
  $('#start_date').on("cut copy paste", function (e) {
    e.preventDefault();
  });
  $('#end_date').on("cut copy paste", function (e) {
    e.preventDefault();
  });

  $("#task_date").datepicker({ minDate: 0 })
  var loc = window.location
  var endpoint = ''
  var wsStart = 'ws://'
  if (loc.protocol == 'https:') {
    wsStart = 'wss://'
  }

  // $(document).on("change","#start_date",function(){  	
  // 	$("#end_date").datepicker( "option", "minDate", new Date($(this).val()) );
  // })

  var endpoint = wsStart + loc.host + "/manager_notify/{{request.user.username}}/"
  var socket = new WebSocket(endpoint)

  socket.onmessage = function (e) {
    e_data = JSON.parse(e.data)
    e_data = JSON.parse(e_data["data"])
    // console.log(e_data)
    if (e_data["email_id"]) {
      email_reply = e_data["email_message"]
      if (e_data["email_message"]) {

        email_reply_html = '<tr><td>' + e_data["email_message"] + '</td><td>' + e_data["email_reply_user_time"] + '</td></tr>'
        $("#email_replies_table_" + e_data["email_id"]).prepend(email_reply_html)
      }
      else {
        // $("#email_" + e_data["email_id"].toString() + "").html(e_data["email_message"])
      }
    }
    else if (e_data["status"]) {
      if (e_data["status"] == "i_am_here") {
        $("#status_" + e_data["staff_id"].toString() + "").html("{% trans 'Online' %}")
        $("#icon_" + e_data["staff_id"].toString() + "").removeClass()
        $("#icon_" + e_data['staff_id'].toString() + "").addClass("fas fa-circle green-color")
      }
      else if (e_data["status"] == "in_meeting") {
        $("#status_" + e_data["staff_id"].toString() + "").html("{% trans 'In Meeting' %}")
        $("#icon_" + e_data["staff_id"].toString() + "").removeClass()
        $("#icon_" + e_data['staff_id'].toString() + "").addClass("fas fa-circle orange-color")
      }
      else if (e_data["status"] == "lunch_break") {
        $("#status_" + e_data["staff_id"].toString() + "").html("{% trans 'Lunch Break' %}")
        $("#icon_" + e_data["staff_id"].toString() + "").removeClass()
        $("#icon_" + e_data['staff_id'].toString() + "").addClass("fas fa-circle orange-color")
      }
      else if (e_data["status"] == "tea_break") {
        $("#status_" + e_data["staff_id"].toString() + "").html("{% trans 'Tea Break' %}")
        $("#icon_" + e_data["staff_id"].toString() + "").removeClass()
        $("#icon_" + e_data['staff_id'].toString() + "").addClass("fas fa-circle orange-color")
      }
      else {
        $("#status_" + e_data["staff_id"].toString() + "").html("{% trans 'Offline' %}")
        $("#icon_" + e_data["staff_id"].toString() + "").removeClass()
        $("#icon_" + e_data['staff_id'].toString() + "").addClass("fas fa-circle red-color")
      }

    }

    if (e_data["ip_loc"]) {
      $("#location_" + e_data["staff_id"].toString() + "").html(e_data["ip_loc"])
    }

  }
  socket.onopen = function (e) {
    console.log("open", e)
  }
  socket.onerror = function (e) {
    console.log("error", e)
  }
  socket.onclose = function (e) {
    console.log("onclose", e)
  }


  $(".open_schedule_calendar").click(function () {
    $("#schedule-date-time").modal("show")
    $(".scheduler_start_date").prop('disabled', false)
    $(".scheduler_end_date").prop('disabled', false)
    $(".schedule_day_off").prop('checked', false)
    $("#add_schedule_btn").attr("data-attr", $(this).attr("data-attr"))
    $("#start_date_scheduler_error").hide()
    $("#end_date_scheduler_error").hide()
    $("#schedule-date-time-error").hide()
    $("#start_date_scheduler").val("")
    $("#end_date_scheduler").val("")
    var hours = new Date().getHours();
      var minutes = new Date().getMinutes();
      var ampm = (hours) >= 12 ? 'PM' : 'AM';

      hours = (hours) % 12;
      hours = hours ? hours : 12;
      hours = ((hours.toString()).length == 1) ? "0" + (hours).toString() : hours;
      minute = ((minutes.toString()).length == 1) ? "0" + minutes.toString() : minutes;
    $(".scheduler_start_date").val(hours.toString()+" : "+minute.toString()+" "+ampm)
    $(".scheduler_end_date").val(hours.toString()+" : "+minute.toString()+" "+ampm)

  })

  function start_date_fn() {
    start_date = $("#start_date_scheduler").val()
    if (start_date == "") {
      $("#start_date_scheduler_error").html("{% trans "This field is required" %}")
      $("#start_date_scheduler_error").show()
      return false
    }
    else {
      $("#start_date_scheduler_error").hide()
      return true
    }
  }

  function end_date_fn() {
    end_date = $("#end_date_scheduler").val()
    if (end_date == "") {
      $("#end_date_scheduler_error").html("{% trans "This field is required" %}")
      $("#end_date_scheduler_error").show()
      return false
    }
    else {
      $("#end_date_scheduler_error").hide()
      return true
    }
  }

  function time_list_validation() {
    error_data = []
    $(".schedule_tr").each(function(){
        start_time = $(this).find(".scheduler_start_date").val()
        end_time = $(this).find(".scheduler_end_date").val()
        if (start_time != "{% trans "Day Off" %}" && end_time != "{% trans 'Day Off' %}"){
          if(start_time == end_time){
            error_data.push(($(this).find(".schedule_day").text()).trim())            
          }
        }
      })
    if(error_data.length != 0){
      error_data_str = error_data.join(", ");
      $("#schedule-date-time-error").html("{% trans 'Start and End time for' %} "+error_data_str+" {% trans 'should not be same' %}.")
      $("#schedule-date-time-error").show()
      return false
    }
    else{
      $("#schedule-date-time-error").hide()
      return true
    }
  }



  $("#add_schedule_btn").click(function () {
    $("#schedule-date-time-error").hide()
  $("#start_date_scheduler_error").hide()
  $("#end_date_scheduler_error").hide()
    start_date_fn()
    end_date_fn()
    time_list_validation()
    if (start_date_fn() && end_date_fn() && time_list_validation()) {
      final_data = []
      $(".schedule_tr").each(function(){
        start_time = $(this).find(".scheduler_start_date").val()
        end_time = $(this).find(".scheduler_end_date").val()
        week_day = $(this).find(".schedule_day").text()
        
        dict = {"scheduler_end_date": end_time, "scheduler_start_date" :start_time, "week_day" : week_day}
        final_data.push(dict)
      })
      console.log(final_data)
      start_date = $("#start_date_scheduler").val()
      end_date = $("#end_date_scheduler").val()
      id = $(this).attr("data-attr")
      $("#page_loader").show()
      $.ajax({
        type: 'POST',
        url: "{% url 'add_schedle_time' %}",
        data: {
          "start_date": start_date,
          "end_date": end_date,
          "time_list" : JSON.stringify(final_data),
          "staff_id": id
        },
        success: function (response) {
          $("#page_loader").hide()
          if (response == 1) {
            $("#schedule-date-time").modal("hide")
            $("#universal_msg").html("{% trans "Schedule time added successfully" %}")
            $("#universal_msg_modal").modal("show")
          }
          else {
            $("#schedule-date-time-error").html(response)
            $("#schedule-date-time-error").show()
          }
        }
      });
    }

  })

  user_online_status(1);

  function user_online_status(tr) {
    if ($('.emp-list table tr').eq(tr).length > 0) {
      var attr_val = $('.emp-list table tr').eq(tr).find('.user_online_status').attr('data-attr');
      console.log(attr_val);

      $.ajax({
        type: 'POST',
        url: "{% url 'check_user_online_status' %}",
        data: {
          "user_id": attr_val,
        },
        success: function (response) {
          response = JSON.parse(response)

          response = response[0]
          console.log(response)
          email = response['user__username']
          var email = email.replace("@", "");
          var email = email.replace(".", "");

          $("#" + email + "_status").removeClass()

          if (response['offline']) {
            $("#status_" + response['user_id'].toString() + "").html("{% trans "Offline" %}")
            $("#icon_" + response['user_id'] + "").removeClass()
            $("#icon_" + response['user_id'] + "").addClass("fas fa-circle red-color")
            $("#" + email + "_status").addClass("fas fa-circle red-color")
          }
          if (response['i_am_here']) {
            $("#status_" + response['user_id'].toString() + "").html("{% trans "Online" %}")
            $("#icon_" + response['user_id'] + "").removeClass()
            $("#icon_" + response['user_id'] + "").addClass("fas fa-circle green-color")
            $("#" + email + "_status").addClass("fas fa-circle green-color")
          }
          if (response['in_meeting']) {
            $("#status_" + response['user_id'].toString() + "").html("{% trans "In Meeting" %}")
            $("#icon_" + response['user_id'] + "").removeClass()
            $("#icon_" + response['user_id'] + "").addClass("fas fa-circle orange-color")
            $("#" + email + "_status").addClass("fas fa-circle orange-color")
          }
          if (response['lunch_break']) {
            $("#status_" + response['user_id'].toString() + "").html("{% trans "Lunch Break" %}")
            $("#icon_" + response['user_id'] + "").removeClass()
            $("#icon_" + response['user_id'] + "").addClass("fas fa-circle orange-color")
            $("#" + email + "_status").addClass("fas fa-circle orange-color")
          }
          if (response['tea_break']) {
            $("#status_" + response['user_id'].toString() + "").html("{% trans "Tea Break" %}")
            $("#icon_" + response['user_id'] + "").removeClass()
            $("#icon_" + response['user_id'] + "").addClass("fas fa-circle orange-color")
            $("#" + email + "_status").addClass("fas fa-circle orange-color")
          }
        }
      });


      tr++;
      setTimeout(function () {
        user_online_status(tr);
      }, 60000);

    } else {
      setTimeout(function () {
        user_online_status(1);
      }, 60000);
    }
  }

  function comment_validation() {
    user_comment = $("#user-comment").val()
    if (user_comment == "") {
      $("#comment_error").html("{% trans "This field is required" %}")
      $("#comment_error").show()
      return false
    }
    else {
      $("#comment_error").hide()
      return true
    }
  }

  function task_validation() {
    today_task = $("#today_task").val()
    if (today_task == "") {
      $("#task_error").html("{% trans "This field is required" %}")
      $("#task_error").show()
      return false
    }
    else {
      $("#task_error").hide()
      return true
    }
  }

  function task_date_validation() {
    task_date = $("#task_date").val()
    if (task_date == "") {
      $("#task_date_error").html("{% trans "This field is required" %}")
      $("#task_date_error").show()
      return false
    }
    else {
      $("#task_date_error").hide()
      return true
    }
  }

  function subject_validation() {
    email_subject = $("#email_subject").val()
    if (email_subject == "") {
      $("#email_subject_error").html("{% trans "This field is required" %}")
      $("#email_subject_error").show()
      return false
    }
    else {
      $("#email_subject_error").hide()
      return true
    }
  }

  function description_validation() {
    email_description = $("#email_description").val()
    if (email_description == "") {
      $("#email_description_error").html("{% trans "This field is required" %}")
      $("#email_description_error").show()
      return false
    }
    else {
      $("#email_description_error").hide()
      return true
    }
  }

 function overtime_validation() {
    user_id = $(this).attr('id')
    start_time = $("#overtime_start_time").val()
    end_time = $("#overtime_end_time").val()
    startdate=$("#start_date_overtime").val()
    
    if (startdate == "") {
      console.log(">>>>>>>>>>>>>>>>>>>>>>>if",user_id);
      console.log(">>>>>>>>>>>>>>>>>>>>>>>",end_time);
      $("#end_time_scheduler_error").html("{% trans "This field is required" %}")
      $("#end_time_scheduler_error").show()
      return false
    }

    else if (end_time <= start_time) {
      console.log(">>>>>>>>>>>>>>>>>>>>>>>elseif",user_id);
      console.log(">>>>>>>>>>>>>>>>>>>>>>>",end_time);
      $("#end_time_scheduler_error").html("{% trans "End time will be greater then start time" %}")
      $("#end_time_scheduler_error").show()
      return false
    }

    else if ( startdate == "" & end_time <= start_time) {
      console.log(">>>>>>>>>>>>>>>>>>>>>>>elseif",user_id);
      console.log(">>>>>>>>>>>>>>>>>>>>>>>",end_time);
      $("#end_time_scheduler_error").html("{% trans "End time will be greater then start time" %}")
      $("#end_time_scheduler_error").show()
      return false
    }

    else {
      $("#start_date_scheduler_error").hide()
      return true
    }
}


  function alert_validation() {
    alert_message = $("#alert_message").val()
    if (alert_message == "") {
      $("#alert_message_error").html("{% trans "This field is required" %}")
      $("#alert_message_error").show()
      return false
    }
    else {
      $("#alert_message_error").hide()
      return true
    }
  }

  function password_validation() {
    password = $("#password").val();
    // var password_regex = /^(?=\S*[a-z][A-Z])(?=\S*\d)(?=\S*[^\w\s])\S{6,}$/;
    password_regex = /^(?=.*\d)(?=.*[!@#$%^&*])(?=.*[a-z])(?=.*[A-Z]).{6,}$/;
    if (password.length == '' || password.length == null) {
      $("#password_label").show()
      $("#password_label").html("{% trans "This field is required" %}")
      return false;
    }
    else {
      if (password.length > 20 || password.length < 6) {
        $("#password_label").show()
        $("#password_label").html("{% trans "Password must contain 6 to 20 characters" %}");
        return false;
      }
      // else if (!!~password.indexOf(' ')) {
      //   $("#password_label").show()
      //   $("#password_label").html("{% trans "Password must not contain white spaces" %}");
      //   return false;
      // }
      else if (password_regex.test(password) == false) {
        $("#password_label").show()
        $("#password_label").html("{% trans "Password must contain Uppercase & lowercase letters, special characters, and numbers." %}");
        return false;
      }
      else {
        $("#password_label").hide()
        return true;
      }
    }
  };

  function confirm_password_validation() {
    pass = $("#password").val();
    password = $("#confirm_password").val();

    if (password.length == '' || password.length == null) {
      $("#confirm_password_label").show()
      $("#confirm_password_label").html("{% trans "This field is required" %}");
      return false;
    }
    else {
      if (password != pass) {
        $("#confirm_password_label").show()
        $("#confirm_password_label").html("{% trans "Passwords should be same" %}");
        return false;
      }
      else {
        $("#confirm_password_label").hide()
        return true;
      }
    }
  };

  $(".change_password_icon").click(function () {
    val = $(this).attr('data-attr')
    split = val.split(",")
    email = split[1]
    name = split[0]
    $("#staticName").val(name)
    $("#staticEmail").val(email)
    $("#password").val("")
    $("#confirm_password").val("")
    $("#change-password").modal("show")
    $("#password_label").hide()
    $("#confirm_password_label").hide()
  })

  $("#change_password_btn").click(function () {
    password_validation()
    confirm_password_validation()
    if (password_validation() && confirm_password_validation()) {
      email = $("#staticEmail").val()
      $.ajax({
        type: 'POST',
        url: "{% url 'change_staff_pass' %}",
        data: {
          "email": email,
          "password": $("#password").val(),
        },
        success: function (response) {
          if (response == 1) {
            $("#change-password").modal("hide")
            $("#universal_msg").html("{% trans "Password changed successfully" %}")
            $("#universal_msg_modal").modal("show")
          }
          else {
            $("#universal_msg_modal11").modal("show")
          }
        }
      });
    }
  })

  $("#send_email_btn").click(function () {
    to_email = $("#to_email").val()
    from_email = $("#from_email").val()
    email_subject = $("#email_subject").val()
    email_description = $("#email_description").val()
    subject_validation()
    description_validation()
    if (subject_validation() && description_validation()) {
      $("#page_loader").show()
      $.ajax({
        type: 'POST',
        url: "{% url 'today_email' %}",
        data: {
          "to_email": to_email,
          "from_email": from_email,
          "email_subject": email_subject,
          "email_description": email_description,
        },
        success: function (response) {
          $("#page_loader").hide()
          if (response == 1) {
            $("#manager-email").modal("hide")
            $("#universal_msg").html("{% trans "Email sent successfully" %}")
            $("#universal_msg_modal").modal("show")
          }
          else {
            $("#universal_msg_modal11").modal("show")
          }
        }
      });
    }
  })

  $(".email_modal").click(function () {
    val = $(this).attr("data-attr")
    val = val.split(",")
    $("#to_email").val(val[0])
    $("#email_to_name").html(val[1])
    $("#email_subject_error").hide()
    $("#email_description_error").hide()
    $("#manager-email").modal("show")
    $("#email_subject").val("")
    $("#email_description").val("")
  })


  $(".task_modal").click(function () {
    user_id = $(this).attr("data-attr")
    $("#assign_task").attr("data-attr", user_id)
    $("#manager-task").modal("show")
    $("#task_date_error").hide()
    $("#task_error").hide()
    $("#task_date").val('')
    $("#today_task").val('')
  })

  $("#assign_task").click(function () {
    user_id = $(this).attr("data-attr")
    task = $("#today_task").val()
    task_validation()
    task_date_validation()
    if (task_validation() && task_date_validation()) {
      $("#page_loader").show()
      $.ajax({
        type: 'POST',
        url: "{% url 'today_task' %}",
        data: {
          "date": $("#task_date").val(),
          "user_id": user_id,
          "task": task
        },
        success: function (response) {
          $("#page_loader").hide()
          if (response == 1) {
            $("#manager-task").modal("hide")
            $("#universal_msg").html("{% trans "Task Assigned successfully" %}")
            $("#universal_msg_modal").modal("show")
          }
          else {
            $("#universal_msg_modal11").modal("show")
          }
        }
      });
    }
  })

  $(".comment_model").click(function () {
    user_id = $(this).attr("data-attr")
    comment = $(this).attr("data-comment")
    name = $(this).attr("data-name")
    $("#comment_error").hide()
    $("#comment_to_name").html(name)
    $("#user-comment").val(comment)
    $("#save-comment").attr("data-attr", user_id)
    $("#manager-comment").modal("show")
  })

  $("#save-comment").click(function () {
    user_id = $(this).attr('data-attr')
    comment = $("#user-comment").val()
    comment_validation()
    if (comment_validation()) {
      $("#page_loader").show()
      $.ajax({
        type: 'POST',
        url: "{% url 'add_comment' %}",
        data: {
          "user_id": user_id,
          "comment": comment
        },
        success: function (response) {
          $("#page_loader").hide()
          if (response == 1) {
            $("#manager-comment").modal("hide")
            $("#universal_msg").html("{% trans "Comment added successfully" %}")
            $("#universal_msg_modal").modal("show")
          }
          else {
            $("#universal_msg_modal11").modal("show")
          }
        }
      });
    }
  })

  $(".alert_btn").click(function () {
    $("#manager-alert").modal("show")
    $("#alert_message").val('')
    $("#send_alert_btn").attr("data-attr", $(this).attr('data-attr'))
    $("#alert_message_error").hide()
  })

  $("#send_alert_btn").click(function () {
    user_id = $(this).attr('data-attr')
    alert_message = $("#alert_message").val()
    alert_validation()
    if (alert_validation()) {
      $("#page_loader").show()
      $.ajax({
        type: 'POST',
        url: "{% url 'alert_user' %}",
        data: {
          "user_id": user_id,
          "alert_message": alert_message,
        },
        success: function (response) {
          $("#page_loader").hide()
          if (response == 1) {
            $("#manager-alert").modal("hide")
            $("#universal_msg").html("{% trans "Alert sent successfully" %}")
            $("#universal_msg_modal").modal("show")
          }
          else {
            $("#universal_msg_modal11").modal("show")
          }
        }
      });
    }
  })

  $(".close-bntn").click(function () {
    location.href = "{% url 'manager_dashboard' %}";
  })
</script>

<script type="text/javascript">


  $('#search_user').autocomplete({
    delay: 100,
    source: function (request, response) {
      $.ajax({
        type: 'POST',
        url: "{% url 'get_searched_users_by_manager' %}",
        data: { "search_data": $("#search_user").val() },
        success: function (data) {
          console.log(data)
          availableTags = []
          data = JSON.parse(data)
          for (var i = 0; i < data.length; i++) {
            if (data[i]['user__username']) {
              availableTags.push({ 'email': data[i]['user_id'], 'label': data[i]['name'], "class": "get_chat_thred" })
            }
            if (data[i]['manaager__username']) {
              availableTags.push({ 'email': data[i]['manaager_id'], 'label': data[i]['full_name'], "class": "get_chat_thred" })
            }
          }

          var keys = availableTags;
          if (keys.length == 0) {
            keys = [{ 'email': "", 'label': "{% trans "No data Found" %}", "class": "" }]
          }
          response(keys)
        }
      });
    },
    minLength: 1,
    select: function (event, ui) {
      console.log(document.querySelector("[data-atttr='" + ui.item.email + "']"))
      document.querySelector("[data-atttr='" + ui.item.email + "']").click()
    }
  }).data("ui-autocomplete")._renderItem = function (ul, item) {
    return $("<li></li>")
      .data("item.autocomplete", item)
      .append("<a class='myclass " + item.class + "' data-atttr='" + item.email + "'>" + item.label + "</a>")
      .appendTo(ul);
  };

  $("#search_user").keydown(function (event) {
    if (event.keyCode == 13) {
      if ($("#search_user").val().length == 0) {
        event.preventDefault();
        return false;
      }
    }
  });


  $(".overtime_icon").click(function () {
    $("#overtime-date-time").modal("show")
    id = $(this).attr("data-attr")
    employee_user_id["staff_id"] = id
    user_id = $(this).attr('data-attr');
    $("#add_overtime_btns").attr("data-attr", user_id)
  })


  $(document).on('click', ".get_chat_thred", function () {
    email = $(this).attr('data-atttr')
    $.ajax({
      type: 'POST',
      url: "{% url 'get_chat_by_manager' %}",
      data: { "email": email },
      success: function (response) {
        $("#message-box-part").html('<div class="d-flex flex-column h-100 justify-content-center"><div class="not-chat text-center"><i class="fab fa-rocketchat"></i></div><div class="not-found mt-2 text-center"><h1>Chat will be shown here.</h1></div></div>')

        if (response == 5) {
          $("#threads_div").html('<div class="d-flex flex-column h-100 justify-content-center no_chat_found"><div class="not-chat mt-5 text-center"><i class="fab fa-rocketchat"></i></div><div class="not-found mt-2 text-center"><h1>No chats found</h1></div></div>')
        }
        else if (response == 0) {
          $("#universal_msg_modal11").modal("show")
        }
        else {
          response = JSON.parse(response)
          html = ''
          for (var i = 0; i < response.length; i++) {
            html += '<a class="block-part d-flex open_user_chat" target="_blank" data-attr="' + response[i]['reciever_div_id_div'] + '" data-chat="{{data.sender_id}}"><div class="img-wrap admin-img mr-3" id="' + response[i]['reciever_div_id_div'] + '_div_box"><img src="/static/img/admin-demo.png" class="admin-img mr-3" title=""></div><div class="message-block mr-2 justify-content-center align-self-center"><h5>' + response[i]['name2'] + ' - ' + response[i]['name'] + '</h5><p id="' + response[i]['reciever_div_id_div'] + '_message_list_msg">' + response[i]["chat_message"] + '</p></div><div class="time-block ml-auto justify-content-center align-self-center"><p id="' + response[i]['reciever_div_id_div'] + '_message_list_date">' + response[i]["date"] + '</p></div></a>'
          }
          $(".no_chat_found").remove()
          $("#threads_div").html(html)
        }
      }
    });
  })

 $("#add_overtime_btns").click(function () {
    // user_id = $(this).attr('data-attr')
    user_id = $(this).attr('data-attr');
    startdate=$("#start_date_overtime").val()
    start_time = $("#overtime_start_time").val()
    end_time = $("#overtime_end_time").val()

    overtime_validation()
    if (overtime_validation()) {
      $("#page_loader").show()
      $.ajax({
        type: 'POST',
        url: "{% url 'saveovertime' %}",
        data: {
          "user_id": user_id,
          "startdate":startdate,
          "starttime":start_time,
          "endtime":end_time
        },

        success: function (response) {
          console.log("response",response)
          $("#page_loader").hide()
          if (response != '') {

           $("#overtime-date-time").modal("hide")
            $("#universal_msg").html("Overtime Add successfully")
            $("#universal_msg_modal").modal("show")
          }
          else {
            $("#universal_msg_modal11").modal("show")
          }
        }
      });
}
    });


      $(".close-bntn").click(function(){

        window.location = "{% url 'employee_listing'  %}"
      })


  $(document).on('click', '.open_user_chat', function () {
    $(".open_user_chat").removeClass("active")
    $(this).addClass("active")
    chat_thread_id = $(this).attr('data-attr')
    // chat_sender_id = $(this).attr('data-chat')
    $.ajax({
      type: 'GET',
      url: "{% url 'get_chat' %}",
      data: {
        "chat_thread_id": chat_thread_id
      },
      success: function (response) {
        if (response == 0) {
          $("#universal_msg_modal11").modal("show")
        }
        else {
          var re = /[\0-\x1F\x7F-\x9F\xAD\u0378\u0379\u037F-\u0383\u038B\u038D\u03A2\u0528-\u0530\u0557\u0558\u0560\u0588\u058B-\u058E\u0590\u05C8-\u05CF\u05EB-\u05EF\u05F5-\u0605\u061C\u061D\u06DD\u070E\u070F\u074B\u074C\u07B2-\u07BF\u07FB-\u07FF\u082E\u082F\u083F\u085C\u085D\u085F-\u089F\u08A1\u08AD-\u08E3\u08FF\u0978\u0980\u0984\u098D\u098E\u0991\u0992\u09A9\u09B1\u09B3-\u09B5\u09BA\u09BB\u09C5\u09C6\u09C9\u09CA\u09CF-\u09D6\u09D8-\u09DB\u09DE\u09E4\u09E5\u09FC-\u0A00\u0A04\u0A0B-\u0A0E\u0A11\u0A12\u0A29\u0A31\u0A34\u0A37\u0A3A\u0A3B\u0A3D\u0A43-\u0A46\u0A49\u0A4A\u0A4E-\u0A50\u0A52-\u0A58\u0A5D\u0A5F-\u0A65\u0A76-\u0A80\u0A84\u0A8E\u0A92\u0AA9\u0AB1\u0AB4\u0ABA\u0ABB\u0AC6\u0ACA\u0ACE\u0ACF\u0AD1-\u0ADF\u0AE4\u0AE5\u0AF2-\u0B00\u0B04\u0B0D\u0B0E\u0B11\u0B12\u0B29\u0B31\u0B34\u0B3A\u0B3B\u0B45\u0B46\u0B49\u0B4A\u0B4E-\u0B55\u0B58-\u0B5B\u0B5E\u0B64\u0B65\u0B78-\u0B81\u0B84\u0B8B-\u0B8D\u0B91\u0B96-\u0B98\u0B9B\u0B9D\u0BA0-\u0BA2\u0BA5-\u0BA7\u0BAB-\u0BAD\u0BBA-\u0BBD\u0BC3-\u0BC5\u0BC9\u0BCE\u0BCF\u0BD1-\u0BD6\u0BD8-\u0BE5\u0BFB-\u0C00\u0C04\u0C0D\u0C11\u0C29\u0C34\u0C3A-\u0C3C\u0C45\u0C49\u0C4E-\u0C54\u0C57\u0C5A-\u0C5F\u0C64\u0C65\u0C70-\u0C77\u0C80\u0C81\u0C84\u0C8D\u0C91\u0CA9\u0CB4\u0CBA\u0CBB\u0CC5\u0CC9\u0CCE-\u0CD4\u0CD7-\u0CDD\u0CDF\u0CE4\u0CE5\u0CF0\u0CF3-\u0D01\u0D04\u0D0D\u0D11\u0D3B\u0D3C\u0D45\u0D49\u0D4F-\u0D56\u0D58-\u0D5F\u0D64\u0D65\u0D76-\u0D78\u0D80\u0D81\u0D84\u0D97-\u0D99\u0DB2\u0DBC\u0DBE\u0DBF\u0DC7-\u0DC9\u0DCB-\u0DCE\u0DD5\u0DD7\u0DE0-\u0DF1\u0DF5-\u0E00\u0E3B-\u0E3E\u0E5C-\u0E80\u0E83\u0E85\u0E86\u0E89\u0E8B\u0E8C\u0E8E-\u0E93\u0E98\u0EA0\u0EA4\u0EA6\u0EA8\u0EA9\u0EAC\u0EBA\u0EBE\u0EBF\u0EC5\u0EC7\u0ECE\u0ECF\u0EDA\u0EDB\u0EE0-\u0EFF\u0F48\u0F6D-\u0F70\u0F98\u0FBD\u0FCD\u0FDB-\u0FFF\u10C6\u10C8-\u10CC\u10CE\u10CF\u1249\u124E\u124F\u1257\u1259\u125E\u125F\u1289\u128E\u128F\u12B1\u12B6\u12B7\u12BF\u12C1\u12C6\u12C7\u12D7\u1311\u1316\u1317\u135B\u135C\u137D-\u137F\u139A-\u139F\u13F5-\u13FF\u169D-\u169F\u16F1-\u16FF\u170D\u1715-\u171F\u1737-\u173F\u1754-\u175F\u176D\u1771\u1774-\u177F\u17DE\u17DF\u17EA-\u17EF\u17FA-\u17FF\u180F\u181A-\u181F\u1878-\u187F\u18AB-\u18AF\u18F6-\u18FF\u191D-\u191F\u192C-\u192F\u193C-\u193F\u1941-\u1943\u196E\u196F\u1975-\u197F\u19AC-\u19AF\u19CA-\u19CF\u19DB-\u19DD\u1A1C\u1A1D\u1A5F\u1A7D\u1A7E\u1A8A-\u1A8F\u1A9A-\u1A9F\u1AAE-\u1AFF\u1B4C-\u1B4F\u1B7D-\u1B7F\u1BF4-\u1BFB\u1C38-\u1C3A\u1C4A-\u1C4C\u1C80-\u1CBF\u1CC8-\u1CCF\u1CF7-\u1CFF\u1DE7-\u1DFB\u1F16\u1F17\u1F1E\u1F1F\u1F46\u1F47\u1F4E\u1F4F\u1F58\u1F5A\u1F5C\u1F5E\u1F7E\u1F7F\u1FB5\u1FC5\u1FD4\u1FD5\u1FDC\u1FF0\u1FF1\u1FF5\u1FFF\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2072\u2073\u208F\u209D-\u209F\u20BB-\u20CF\u20F1-\u20FF\u218A-\u218F\u23F4-\u23FF\u2427-\u243F\u244B-\u245F\u2700\u2B4D-\u2B4F\u2B5A-\u2BFF\u2C2F\u2C5F\u2CF4-\u2CF8\u2D26\u2D28-\u2D2C\u2D2E\u2D2F\u2D68-\u2D6E\u2D71-\u2D7E\u2D97-\u2D9F\u2DA7\u2DAF\u2DB7\u2DBF\u2DC7\u2DCF\u2DD7\u2DDF\u2E3C-\u2E7F\u2E9A\u2EF4-\u2EFF\u2FD6-\u2FEF\u2FFC-\u2FFF\u3040\u3097\u3098\u3100-\u3104\u312E-\u3130\u318F\u31BB-\u31BF\u31E4-\u31EF\u321F\u32FF\u4DB6-\u4DBF\u9FCD-\u9FFF\uA48D-\uA48F\uA4C7-\uA4CF\uA62C-\uA63F\uA698-\uA69E\uA6F8-\uA6FF\uA78F\uA794-\uA79F\uA7AB-\uA7F7\uA82C-\uA82F\uA83A-\uA83F\uA878-\uA87F\uA8C5-\uA8CD\uA8DA-\uA8DF\uA8FC-\uA8FF\uA954-\uA95E\uA97D-\uA97F\uA9CE\uA9DA-\uA9DD\uA9E0-\uA9FF\uAA37-\uAA3F\uAA4E\uAA4F\uAA5A\uAA5B\uAA7C-\uAA7F\uAAC3-\uAADA\uAAF7-\uAB00\uAB07\uAB08\uAB0F\uAB10\uAB17-\uAB1F\uAB27\uAB2F-\uABBF\uABEE\uABEF\uABFA-\uABFF\uD7A4-\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA-\uFAFF\uFB07-\uFB12\uFB18-\uFB1C\uFB37\uFB3D\uFB3F\uFB42\uFB45\uFBC2-\uFBD2\uFD40-\uFD4F\uFD90\uFD91\uFDC8-\uFDEF\uFDFE\uFDFF\uFE1A-\uFE1F\uFE27-\uFE2F\uFE53\uFE67\uFE6C-\uFE6F\uFE75\uFEFD-\uFF00\uFFBF-\uFFC1\uFFC8\uFFC9\uFFD0\uFFD1\uFFD8\uFFD9\uFFDD-\uFFDF\uFFE7\uFFEF-\uFFFB\uFFFE\uFFFF]/g;


          response = JSON.parse(response)
          managerr_id = response[0]["managerr_id"].toString()

          thread_id = response[0]["messages_obj"][0]['thread_id']
          response = response[0]["messages_obj"]

          // console.log(thread_id)
          html = ""
          for (var i = 0; i < response.length; i++) {

            day = (((response[i]["day"]).toString()).length == 1) ? "0" + (response[i]["day"]).toString() : response[i]["day"];
            month = (((response[i]["month"]).toString()).length == 1) ? "0" + (response[i]["month"]).toString() : response[i]["month"];
            minute = (((response[i]["minute"]).toString()).length == 1) ? "0" + (response[i]["minute"]).toString() : response[i]["minute"];

            var betterInt = parseInt((response[i]["hour"].toString()).replace(re, ''), 10);
            var ampm = (betterInt) >= 12 ? 'PM' : 'AM';

            hours = (betterInt) % 12;
            hours = hours ? hours : 12;
            hours = ((hours.toString()).length == 1) ? "0" + (hours).toString() : hours;
            date = day + "/" + month + "/" + response[i]["year"] + " , " + hours + ":" + minute + "  " + ampm
            sender_id = response[i]["sender_id"].toString()
            reciever_id = response[i]["reciever_id"].toString()

            // sender_id = "{{request.user.id}}"

            if (sender_id == managerr_id) {
              html += '<div class="d-flex"><div class="sender pt-3  ml-auto"><p>' + response[i]["name"] + ' : ' + response[i]["message"] + '</p><div class="time">' + date + '</div></div></div>'
            }
            else {
              html += '<div class="receiver pt-3"><p>' + response[i]["name"] + ' : ' + response[i]["message"] + '</p><div class="time">' + date + '</div></div>'
            }

          }
          $("#message-box-part").removeClass()
          $("#message-box-part").addClass("message-box " + thread_id + "_chat_box")
          $("#message-box-part").html(html)
          div = $("." + thread_id + "_chat_box");
          div.scrollTop(div.prop('scrollHeight'));
        }
      }
    });
  })

  var loc = window.location
  var endpoint = ''
  var wsStart = 'ws://'
  if (loc.protocol == 'https:') {
    wsStart = 'wss://'
  }

  a = wsStart + loc.host + "/char_bxx/"
  var exampleSocket = new WebSocket(a);
  exampleSocket.onmessage = function (e) {
    // console.log("message", e)
    e_data = JSON.parse(e.data)
    e_data = JSON.parse(e_data.data)



    if ($("#" + e_data['reciever_div_id_div'] + "_div_box").length == 0) {

      if (e_data["chat_message"] && e_data['name'] && e_data['name2'] && e_data['reciever_div_id_div'] && e_data["date"]) {
        html = '<a class="block-part d-flex open_user_chat" target="_blank" data-attr="' + e_data['reciever_div_id_div'] + '" data-chat="{{data.sender_id}}"><div class="img-wrap admin-img mr-3" id="' + e_data['reciever_div_id_div'] + '_div_box"><img src="/static/img/admin-demo.png" class="admin-img mr-3" title=""></div><div class="message-block mr-2 justify-content-center align-self-center"><h5>' + e_data['name2'] + ' - ' + e_data['name'] + '</h5><p id="' + e_data['reciever_div_id_div'] + '_message_list_msg">' + e_data["chat_message"] + '</p></div><div class="time-block ml-auto justify-content-center align-self-center"><p id="' + e_data['reciever_div_id_div'] + '_message_list_date">' + e_data["date"] + '</p></div></a>'
        $(".no_chat_found").remove()
        $("#threads_div").prepend(html)

      }
      // html = '<a class="block-part d-flex open_user_chat" target="_blank" data-attr="'+e_data['reciever_div_id_div']+'" data-chat="{{data.sender_id}}"><div class="img-wrap admin-img mr-3" id="'+e_data['reciever_div_id_div']+'_div_box"><img src="/static/img/admin-demo.png" class="admin-img mr-3" title=""></div><div class="message-block mr-2 justify-content-center align-self-center"><h5>'+ e_data['name'] +' - '+ e_data['name2'] +'</h5><p id="'+e_data['reciever_div_id_div']+'_message_list_msg">'+ e_data["chat_message"] +'</p></div><div class="time-block ml-auto justify-content-center align-self-center"><p id="'+e_data['reciever_div_id_div']+'_message_list_date">' + e_data["date"] + '</p></div></a>'
      // $("#threads_div").prepend(html)

    }
    else {

    }


    if (e_data['reciever_manager_id']) {
      $("#" + e_data['reciever_div_id_div'] + "_message_list_msg").html(e_data["chat_message"])
      $("#" + e_data['reciever_div_id_div'] + "_message_list_date").html(e_data["date"])
      $("." + e_data['reciever_div_id_div'] + "_chat_box").append('<div class="receiver pt-3"><p>' + e_data["name"] + ' : ' + e_data["chat_message"] + '</p><div class="time">' + e_data['date'] + '</div></div>')
      div = $("." + e_data['reciever_div_id_div'] + "_chat_box");
      div.scrollTop(div.prop('scrollHeight'));
    }

    if (e_data['manager_id']) {

      $("#" + e_data['reciever_div_id_div'] + "_message_list_msg").html(e_data["chat_message"])
      $("#" + e_data['reciever_div_id_div'] + "_message_list_date").html(e_data["date"])
      $("." + e_data['reciever_div_id_div'] + "_chat_box").append('<div class="d-flex"><div class="sender pt-3  ml-auto"><p>' + e_data["name"] + ' : ' + e_data["chat_message"] + '</p><div class="time">' + e_data['date'] + '</div></div></div>')
      div = $("." + e_data['reciever_div_id_div'] + "_chat_box");
      div.scrollTop(div.prop('scrollHeight'));
    }

    // if (e_data["chat_message"]) {
    //   $("#" + e_data["user_div_message_id"] + "_msg").html("<b>" + e_data["chat_message"] + "</b>")
    //   $("#" + e_data["user_div_message_id"] + "_date").html(e_data["date"])
    // }
  }
  exampleSocket.onopen = function (e) {
    // console.log("o--pen", e)
  }
  exampleSocket.onerror = function (e) {
    console.log("error", e)
  }
  exampleSocket.onclose = function (e) {
    console.log("onclose", e)
  }
</script>

<script type="text/javascript">
  var loc = window.location
  var endpoint = ''
  var wsStart = 'ws://'
  if (loc.protocol == 'https:') {
    wsStart = 'wss://'
  }

  a = wsStart + loc.host + "/chat_bxx/"
  var exampleSocket = new WebSocket(a);
  exampleSocket.onmessage = function (e) {
    console.log("message", e)
    e_data = JSON.parse(e.data)
    e_data = JSON.parse(e_data.data)
    $("#" + e_data["staff_div_id"] + "_status").removeClass()
    if (e_data["status"] == "i_am_here") {
      $("#" + e_data["staff_div_id"] + "_status").addClass("fas fa-circle green-color")
    }
    if (e_data["status"] == "offline") {
      $("#" + e_data["staff_div_id"] + "_status").addClass("fas fa-circle red-color")
    }
    else {
      $("#" + e_data["staff_div_id"] + "_status").addClass("fas fa-circle orange-color")
    }
  }
  exampleSocket.onopen = function (e) {
    console.log("ow--pen", e)
  }
  exampleSocket.onerror = function (e) {
    console.log("error", e)
  }
  exampleSocket.onclose = function (e) {
    console.log("onclose", e)
  }


  // scroller

  $(".ui-autocomplete").scrollBox();
</script>

<script>

  // open a socket connection
  var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
  const chatSocket = new WebSocket(
    ws_scheme
    + '://'
    + window.location.host
    + '/ws/startCall/'
  );

  // listen to data on socket communication
  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    var meeting_id = data['meeting_id'];// meeting id sent to user browser through socket
    //https://meet.mgdsw.info:13043/${meeting_id}/
    var role = $('#user_role').val(); // user role of current logged in user
    var username = $('#user_name').val(); // username of current logged in user
    if (role == 2 && username == meeting_id) { // the call invitation will be shown to user if user role is employee and meeting id created through socket is same as current logged in username
      var body = `{% trans "You are invited to join the video call. Please join here" %} - <a href='/jitsi/meeting/${meeting_id}/' target='_blank'>{% trans "JOIN NOW" %}</a>`;
      $('#myModal').find('.modal-body').html(body);

      $("#myModal").modal()
    }

  };

  // on manager role, clicking on call button will pass the username on socket and send notification to that user for a call accept.
  $(".meeting_id").click(function () {
    userToCall = $(this).attr('attr');
    start(userToCall);
  });

  // start socket connection
  function start(name) {
    chatSocket.send(JSON.stringify({
      'meeting_id': name,
    }));
  }

  chatSocket.onopen = function open() {
    console.log('WebSockets connection created.');
  };


  chatSocket.onclose = function (e) {
    console.error('Chat socket closed unexpectedly');
  };


</script>
{% endblock %}